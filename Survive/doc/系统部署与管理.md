###router

router在整个服务器组中唯一配置,其主要职责是将来自一个daemonserver的消息路由到其它daemonserver。
其默认监听端口是8888,供daemonserver主动连接.


###daemonserver

daemonserver作为每台物理机器的守护进程，负责启动/关闭应用进程.
daemonserver启动后会一直尝试连接router,直到连接成功.daemonserve同时监听0.0.0.0:8889,供管理客户端,GM工具及应用进程
[groupserver和chatserver,主要是GM操作]的连接.


###配置管理

服务器组的物理机器进程配置存放在一个固定ip的(redis/ssdb)数据库上(称为globaldb),key为world,value为一个hash表,内容如下:

				world
			 /    |    \ 
	    大区1   大区2   大区3  

其中大区也是一个hash表,其key为区名,例如大区1.

假设一个大区1中配置两台物理机器，内网ip分别为[192.168.1.10],[192.168.1.11].
则[globaldb][world][大区1]表中将有两个key分别为[192.168.1.10],[192.168.1.11].(注:value以lua table展示，实际存储为json字符串)

        key=192.168.1.10
        value = {   {type="gateserver",name="gate1",host="211.128.130.2",port=8010,agentcount=4},
                          {type="gameserver",name="game1",host="192.168.1.10",port = 8011},
                          {type="groupserver",name="groupserver",host="192.168.1.10",port = 8014},
                          {type="chatserver",name="chatserver",host="192.168.1.10",port=8015}}
                
        key=192.168.1.11
        value = {   {type="gateserver",name="gate1",host="211.128.130.2",port=8010,agentcount=4},
                          {type="gameserver",name="game1",host="192.168.1.10",port = 8011}}


router启动之后会向配置数据库索取配置信息.每当有daemonserver连接上router,router会根据ip检查合法性.


###应用进程数据

应用进程在一台物理机器上第一次启动时,会以区名.内网ip.name作为key,向globaldb[porcess]插入一个字段,字段也是一个hash表,
这个hash表有以下字段[info],[pid],[lastupdata],[startcount].其中[info]字段是进程的统计数据信息,[pid]是进程的pid,[lastupdate]是进程上次刷新数据的时间,
[startcount]进程的启动次数,进程每次启动都会将这个值+1,进程在运行的过程中会以固定的频率将自己的状态刷新到这个表中.

[lastupdate]的作用,主要用于判断进程的存活,如果[lastupdate]的值距离当前时间超过一定的值,则可以判定进程已经死亡或至少进入了死循环.
至于为什么不通过应用进程与daemonserver的连接断开或者子进程终结信号来判断应用进程的存活性,原因是避免因为daemonserver的意外终结导致信息的丢失.


###管理客户端

管理客户端可以连接上任意一台有外网ip的daemonserver对服务器组进行管理.用户及其权限由[globaldb][user]控制.当管理客户端连接上daemonserver后,
daemonserver向globaldb索取机器配置信息及应用进程信息,发送给管理客户端,并启动一个定时器,定时向globaldb索取最新信息推送到管理客户端.

管理客户端的基本命令包括:

		list world:  显示所有大区  
        list machine:显示服务器组机器信息
        list ip:           显示ip服务器上的进程信息
        list pid:         显示pid进程的信息
        start ip all:   启动ip机器上配置的所有进程
        start  ip name : 启动ip机器上名字为name的进程
        stop  ip all:   正常停止ip机器上的所有进程
        stop  ip name:正常停止ip机器上名字为name的进程
        kill  ip pid:杀掉ip机器上pid进程

当请求命令不在连接的daemonserver上时,命令会通过router路由到正确的机器上去执行.




